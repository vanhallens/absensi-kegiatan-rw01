<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Kegiatan RW</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab5 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
    .input-focus:focus { border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
    .toast { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Loader */
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #f59e0b; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full bg-gray-50">
  
  <div id="app" class="h-full overflow-auto"></div>

  <script>
    // ==================== CONFIGURATION ====================
    const Config = {
      // LATEST API URL
      API_URL: "https://script.google.com/macros/s/AKfycbwZZH4tbP0qK59T7b_o4I9Ux0vpVZwSZn5ZEgcB0ejKgUG3d4VVZgWaSceY6u2Id36O/exec", 
      
      APP_TITLE: 'Absensi Kegiatan RW',
      RW_NAME: 'RW 01'
    };

    // ==================== STATE MANAGEMENT ====================
    const State = {
      currentUser: null,
      currentView: 'login',
      allActivities: [],
      allAttendances: [],
      temp: {
        capturedPhoto: null,
        signatureData: null,
        location: null,
        videoStream: null,
        selectedActivityId: null,
        deleteActivityId: null,
        hasSignature: false // New flag to track if user has signed
      }
    };

    // ==================== API SERVICE ====================
    const Api = {
      async request(action, data = {}) {
        try {
          const response = await fetch(Config.API_URL, {
            method: 'POST',
            body: JSON.stringify({ action, data })
          });
          const result = await response.json();
          
          if (result.status === 'success') return result.data;
          else throw new Error(result.message || 'Terjadi kesalahan');
        } catch (error) {
          console.error("API Error:", error);
          Utils.showToast(error.message, 'error');
          throw error;
        }
      },

      async login(username, password) {
        return await Api.request('login', { username, password });
      },

      async register(formData) {
        return await Api.request('register', formData);
      },

      async getActivities() {
        State.allActivities = await Api.request('getActivities');
      },

      async getAttendances() {
        State.allAttendances = await Api.request('getAttendances');
      },

      async addActivity(formData) {
        return await Api.request('addActivity', {
          name: formData.name,
          date: formData.date,
          time: formData.time,
          location: formData.location
        });
      },

      async toggleActivity(id) {
        return await Api.request('toggleActivity', { id });
      },

      async deleteActivity(id) {
        return await Api.request('deleteActivity', { id });
      },

      async submitAttendance(attendanceData) {
        return await Api.request('submitAttendance', attendanceData);
      }
    };

    // ==================== UTILITIES ====================
    const Utils = {
      formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
      },
      
      formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('id-ID', { 
            day: 'numeric', month: 'short', year: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });
      },

      showToast(message, type = 'success') {
        const existing = document.getElementById('toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = `toast fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 shadow-lg ${
          type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },

      togglePassword(inputId, btnId) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (input.type === "password") {
          input.type = "text";
          btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>`;
        } else {
          input.type = "password";
          btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm2 3-2a3 3 0 11-4 0 3 3 0 014 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
        }
      },

      async getLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject("Geolocation tidak didukung browser ini");
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              name: `Lat: ${pos.coords.latitude.toFixed(4)}, Lng: ${pos.coords.longitude.toFixed(4)}`
            }),
            (err) => reject("Gagal mendapatkan lokasi. Pastikan GPS aktif.")
          );
        });
      }
    };

    // ==================== UI COMPONENTS (RENDERERS) ====================
    const UI = {
      render() {
        const app = document.getElementById('app');
        
        if (!State.currentUser) {
          app.innerHTML = State.currentView === 'register' ? UI.registerPage() : UI.loginPage();
        } else {
          if (State.currentUser.role === 'admin') {
            app.innerHTML = UI.adminDashboard();
          } else {
            app.innerHTML = UI.userDashboard();
          }
        }
        App.attachEvents();
      },

      loginPage() {
        return `
          <div class="min-h-full gradient-bg flex items-center justify-center p-4 fade-in">
            <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <svg class="w-10 h-10 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">${Config.APP_TITLE}</h1>
                <p class="text-blue-200">${Config.RW_NAME}</p>
              </div>
              <div class="bg-white rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Masuk</h2>
                <form id="loginForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="loginUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Masukkan username">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Masukkan password">
                  </div>
                  <button type="submit" id="loginBtn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg transition-all">Masuk</button>
                </form>
                <div class="mt-6 text-center">
                  <p class="text-gray-600">Belum punya akun? <button id="goToRegister" class="text-amber-600 font-semibold">Daftar Sekarang</button></p>
                </div>
              </div>
            </div>
          </div>`;
      },

      registerPage() {
        const rtOptions = Array.from({length: 16}, (_, i) => {
          const num = i + 1;
          const val = num < 10 ? `0${num}` : `${num}`;
          return `<option value="RT ${val}">RT ${val}</option>`;
        }).join('');

        return `
          <div class="min-h-full gradient-bg flex items-center justify-center p-4 fade-in">
            <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">${Config.APP_TITLE}</h1>
                <p class="text-blue-200">Registrasi Warga Baru</p>
              </div>
              <div class="bg-white rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Daftar Akun</h2>
                <form id="registerForm" class="space-y-4">
                  
                  <input type="text" id="regFullName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Nama Lengkap">
                  
                  <select id="regRt" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none">
                    <option value="">Pilih RT</option>
                    ${rtOptions}
                  </select>

                  <!-- Jabatan -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jabatan</label>
                    <select id="regJabatan" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none">
                      <option value="">Pilih Jabatan</option>
                      <option value="Ketua RW">Ketua RW</option>
                      <option value="Ketua RT">Ketua RT</option>
                      <option value="Ketua PKK">Ketua PKK</option>
                      <option value="Ketua Dawis">Ketua Dawis</option>
                      <option value="Ketua Posyandu">Ketua Posyandu</option>
                      <option value="Bendahara RW">Bendahara RW</option>
                      <option value="Sekretaris">Sekretaris</option>
                      <option value="Ketua LMK">Ketua LMK</option>
                      <option value="Ket. Karang Taruna">Ket. Karang Taruna</option>
                      <option value="Lainnya">Lainnya</option>
                    </select>
                    <!-- Custom Jabatan Input (Hidden initially) -->
                    <input type="text" id="regJabatanCustom" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none mt-2 hidden" placeholder="Tulis jabatan Anda...">
                  </div>

                  <input type="tel" id="regPhone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none" placeholder="No. HP">
                  
                  <input type="text" id="regUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Username">
                  
                  <!-- Password Field with Eye Icon -->
                  <div class="relative">
                    <input type="password" id="regPassword" required minlength="6" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Password (Min 6)">
                    <button type="button" id="togglePassReg" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 focus:outline-none">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm2 3-2a3 3 0 11-4 0 3 3 0 014 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                  </div>
                  
                  <!-- Confirm Password Field with Eye Icon -->
                  <div class="relative">
                    <input type="password" id="regConfirmPassword" required class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg input-focus outline-none" placeholder="Konfirmasi Password">
                    <button type="button" id="togglePassConfirm" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 focus:outline-none">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm2 3-2a3 3 0 11-4 0 3 3 0 014 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                  </div>

                  <button type="submit" id="registerBtn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg transition-all">Daftar</button>
                </form>
                <div class="mt-6 text-center">
                  <button id="goToLogin" class="text-amber-600 font-semibold">‚Üê Kembali ke Login</button>
                </div>
              </div>
            </div>
          </div>`;
      },

      userDashboard() {
        const activities = State.allActivities.filter(a => a.activityStatus === 'active');
        let myAttendances = State.allAttendances.filter(a => a.userId === State.currentUser.id);
        myAttendances.sort((a, b) => new Date(b.attendanceTime) - new Date(a.attendanceTime));

        return `
          <div class="min-h-full bg-gray-50 pb-20">
            <header class="gradient-bg text-white p-4 shadow-lg sticky top-0 z-20">
              <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div>
                  <h1 class="text-xl font-bold">${Config.APP_TITLE}</h1>
                  <p class="text-blue-200 text-sm">Halo, ${State.currentUser.fullName}</p>
                </div>
                <button id="logoutBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm">Keluar</button>
              </div>
            </header>
            
            <main class="max-w-4xl mx-auto p-4 space-y-6 fade-in">
              
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl card-shadow">
                  <p class="text-2xl font-bold text-gray-800">${activities.length}</p>
                  <p class="text-sm text-gray-500">Kegiatan Aktif</p>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow">
                  <p class="text-2xl font-bold text-gray-800">${myAttendances.length}</p>
                  <p class="text-sm text-gray-500">Total Hadir</p>
                </div>
              </div>

              <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50">
                  <h2 class="font-bold text-gray-800">üìã Kegiatan Tersedia</h2>
                </div>
                <div class="divide-y divide-gray-100">
                  ${activities.length === 0 ? '<div class="p-8 text-center text-gray-500">Tidak ada kegiatan aktif saat ini.</div>' : ''}
                  ${activities.map(act => {
                    const hasAttended = myAttendances.some(a => a.activityId === act.__backendId);
                    return `
                    <div class="p-4 flex justify-between items-start hover:bg-gray-50 transition-colors">
                      <div>
                        <h3 class="font-semibold text-gray-800">${act.activityName}</h3>
                        <div class="mt-1 space-y-0.5">
                          <p class="text-sm text-gray-500">üìÖ ${Utils.formatDate(act.activityDate)} ‚Ä¢ üïê ${act.activityTime}</p>
                          <p class="text-sm text-gray-500">üìç ${act.activityLocation}</p>
                        </div>
                      </div>
                      ${hasAttended 
                        ? '<span class="mt-2 bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap">‚úì Sudah Absen</span>' 
                        : `<button data-attend="${act.__backendId}" class="mt-2 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm">Absen Sekarang</button>`
                      }
                    </div>`;
                  }).join('')}
                </div>
              </div>

              <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                  <h2 class="font-bold text-gray-800">üìù Riwayat Kehadiran Saya</h2>
                  <span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-medium">${myAttendances.length} Catatan</span>
                </div>
                
                <div class="max-h-[500px] overflow-y-auto">
                  ${myAttendances.length === 0 ? `
                    <div class="p-10 text-center text-gray-400">
                      <svg class="w-16 h-16 mx-auto mb-2 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                      <p>Belum ada riwayat kehadiran</p>
                    </div>
                  ` : ''}
                  
                  <div class="divide-y divide-gray-100">
                    ${myAttendances.map(att => {
                      const act = State.allActivities.find(a => a.__backendId === att.activityId);
                      const actName = act ? act.activityName : 'Kegiatan tidak tersedia';
                      const dateObj = new Date(att.attendanceTime);
                      const dateStr = dateObj.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                      const timeStr = dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                      return `
                      <div class="p-4 flex gap-4 hover:bg-blue-50/30 transition-colors cursor-default">
                        <div class="flex-shrink-0">
                           ${att.photoData 
                             ? `<img src="${att.photoData}" class="w-16 h-16 rounded-lg object-cover border border-gray-200 shadow-sm" onclick="window.open('${att.photoData}')">` 
                             : `<div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 text-xs">No Foto</div>`
                           }
                        </div>
                        <div class="flex-1 min-w-0">
                          <h3 class="font-semibold text-gray-900 truncate">${actName}</h3>
                          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 mt-1 text-sm">
                            <span class="text-gray-500 flex items-center gap-1">
                              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                              ${dateStr}
                            </span>
                            <span class="text-gray-500 flex items-center gap-1">
                              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                              ${timeStr}
                            </span>
                          </div>
                          <div class="mt-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Hadir</span>
                          </div>
                        </div>
                      </div>`;
                    }).join('')}
                  </div>
                </div>
              </div>
            </main>
            ${UI.attendanceModal()}
          </div>`;
      },

      attendanceModal() {
        return `
          <div id="attendanceModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
              <div class="p-4 border-b flex justify-between">
                <h3 class="font-bold text-lg">üì∏ Absensi</h3>
                <button id="closeAttendanceModal" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
              </div>
              <div class="p-4 space-y-4">
                
                <!-- Camera Section -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Foto Wajah</label>
                  <div class="relative bg-gray-900 rounded-lg overflow-hidden aspect-video shadow-inner">
                    <video id="cameraVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                    <img id="capturedImage" class="w-full h-full object-cover hidden">
                  </div>
                  <div class="flex gap-2 mt-2">
                    <button id="captureBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-medium transition-colors">üì∑ Ambil Foto</button>
                    <button id="retakeBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2.5 rounded-lg font-medium transition-colors hidden">üîÑ Ulangi Foto</button>
                  </div>
                </div>

                <!-- Signature Section -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Tanda Tangan</label>
                  <div class="relative border-2 border-gray-300 rounded-lg bg-white overflow-hidden touch-none" id="sigContainer" style="touch-action: none;">
                    <canvas id="signatureCanvas" class="w-full h-32 rounded-lg cursor-crosshair"></canvas>
                    <button type="button" id="clearSignature" class="absolute top-2 right-2 text-xs bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded hover:bg-red-100">Hapus</button>
                  </div>
                  <p class="text-xs text-gray-400 mt-1">Silakan tanda tangan di kotak di atas</p>
                </div>
                
                <!-- Location Section -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi GPS</label>
                  <div id="locationStatus" class="bg-gray-100 p-3 rounded-lg text-sm text-gray-600 min-h-[2.5rem] flex items-center">‚è≥ Mendeteksi lokasi...</div>
                  <button id="refreshLocation" class="text-xs text-blue-600 mt-2 font-medium hover:underline">Refresh Lokasi</button>
                </div>
                
                <button id="submitAttendance" disabled class="w-full btn-primary text-white py-3 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg">‚úì Kirim Absensi</button>
              </div>
            </div>
          </div>`;
      },

      adminDashboard() {
        return `
          <div class="min-h-full bg-gray-50 pb-20">
            <header class="gradient-bg text-white p-4 sticky top-0 z-20">
              <div class="max-w-6xl mx-auto flex justify-between">
                <div><h1 class="text-xl font-bold">${Config.APP_TITLE}</h1><p class="text-blue-200 text-sm">Admin Panel</p></div>
                <button id="logoutBtn" class="bg-white/20 px-3 py-1 rounded text-sm">Keluar</button>
              </div>
            </header>
            
            <nav class="bg-white shadow sticky top-[60px] z-10 overflow-x-auto">
              <div class="flex max-w-6xl mx-auto">
                <button data-tab="dashboard" class="admin-tab px-6 py-3 border-b-2 border-amber-500 text-amber-600 font-medium whitespace-nowrap">Dashboard</button>
                <button data-tab="activities" class="admin-tab px-6 py-3 border-b-2 border-transparent text-gray-500 font-medium whitespace-nowrap">Kegiatan</button>
                <button data-tab="report" class="admin-tab px-6 py-3 border-b-2 border-transparent text-gray-500 font-medium whitespace-nowrap">Laporan</button>
              </div>
            </nav>

            <main class="max-w-6xl mx-auto p-4 fade-in">
              <div id="tab-dashboard" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div class="bg-white p-6 rounded-xl card-shadow">
                    <p class="text-3xl font-bold text-gray-800">${State.allActivities.length}</p>
                    <p class="text-gray-500">Total Kegiatan</p>
                  </div>
                  <div class="bg-white p-6 rounded-xl card-shadow">
                    <p class="text-3xl font-bold text-gray-800">${State.allAttendances.length}</p>
                    <p class="text-gray-500">Total Kehadiran</p>
                  </div>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                  <div class="p-4 border-b"><h2 class="font-bold">Kehadiran Terbaru</h2></div>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                      <thead class="bg-gray-50"><tr><th class="p-3">Nama</th><th class="p-3">Kegiatan</th><th class="p-3">Waktu</th><th class="p-3">Foto</th></tr></thead>
                      <tbody class="divide-y">
                        ${State.allAttendances.slice(0, 5).map(att => {
                          const act = State.allActivities.find(a => a.__backendId === att.activityId);
                          return `
                          <tr>
                            <td class="p-3 font-medium">${att.userFullName}<br><span class="text-xs text-gray-500">${att.userRt}</span></td>
                            <td class="p-3">${act?.activityName || '-'}</td>
                            <td class="p-3">${att.attendanceTime}</td>
                            <td class="p-3">
                              ${att.photoData ? `<img src="${att.photoData}" class="w-10 h-10 rounded object-cover cursor-pointer" onclick="window.open(this.src)">` : '-'}
                            </td>
                          </tr>`;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div id="tab-activities" class="tab-content hidden">
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                  <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="font-bold">Daftar Kegiatan</h2>
                    <button id="addActivityBtn" class="btn-primary text-white px-4 py-2 rounded text-sm">+ Tambah</button>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                      <thead class="bg-gray-50"><tr><th class="p-3">Nama</th><th class="p-3">Tanggal</th><th class="p-3">Status</th><th class="p-3">Aksi</th></tr></thead>
                      <tbody class="divide-y">
                        ${State.allActivities.map(act => `
                          <tr>
                            <td class="p-3 font-medium">${act.activityName}</td>
                            <td class="p-3">${Utils.formatDate(act.activityDate)}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${act.activityStatus === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">${act.activityStatus}</span></td>
                            <td class="p-3 flex gap-2">
                              <button data-toggle="${act.__backendId}" class="text-blue-600 hover:underline">${act.activityStatus === 'active' ? 'Tutup' : 'Buka'}</button>
                              <button data-delete="${act.__backendId}" class="text-red-600 hover:underline">Hapus</button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div id="tab-report" class="tab-content hidden">
                <div class="bg-white rounded-xl card-shadow p-4">
                  <h2 class="font-bold mb-4">Rekap Laporan</h2>
                  <div class="flex gap-4 flex-col md:flex-row mb-4">
                    <select id="reportActivity" class="border p-2 rounded w-full md:w-1/2 input-focus outline-none">
                      <option value="">Pilih Kegiatan</option>
                      ${State.allActivities.map(act => `<option value="${act.__backendId}">${act.activityName}</option>`).join('')}
                    </select>
                    <button id="generateReport" class="btn-primary text-white px-4 py-2 rounded">Tampilkan</button>
                  </div>
                  <div id="reportResult" class="hidden overflow-x-auto">
                    <table id="reportTable" class="w-full text-sm text-left border">
                      <thead class="bg-gray-100"><tr><th class="p-2 border">No</th><th class="p-2 border">Nama</th><th class="p-2 border">RT</th><th class="p-2 border">Waktu</th></tr></thead>
                      <tbody id="reportBody"></tbody>
                    </table>
                    <button id="exportPdf" class="mt-4 bg-red-600 text-white px-4 py-2 rounded text-sm">Download PDF</button>
                  </div>
                </div>
              </div>
            </main>
            ${UI.activityModal()}
            ${UI.deleteModal()}
          </div>`;
      },

      activityModal() {
        return `
          <div id="activityModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md p-6">
              <h3 class="font-bold text-lg mb-4">Tambah Kegiatan</h3>
              <form id="activityForm" class="space-y-4">
                <input type="text" id="actName" required class="w-full border p-2 rounded input-focus outline-none" placeholder="Nama Kegiatan">
                <input type="date" id="actDate" required class="w-full border p-2 rounded input-focus outline-none">
                <input type="time" id="actTime" required class="w-full border p-2 rounded input-focus outline-none">
                <input type="text" id="actLocation" required class="w-full border p-2 rounded input-focus outline-none" placeholder="Lokasi">
                <div class="flex gap-2">
                  <button type="button" id="closeActivityModal" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded">Batal</button>
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded">Simpan</button>
                </div>
              </form>
            </div>
          </div>`;
      },

      deleteModal() {
        return `
          <div id="deleteModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2 text-red-600">‚ö†Ô∏è</div>
              <h3 class="font-bold text-lg mb-2">Hapus Kegiatan?</h3>
              <p class="text-sm text-gray-500 mb-4">Data tidak bisa dikembalikan.</p>
              <div class="flex gap-2">
                <button id="cancelDelete" class="flex-1 bg-gray-200 py-2 rounded">Batal</button>
                <button id="confirmDelete" class="flex-1 bg-red-600 text-white py-2 rounded">Hapus</button>
              </div>
            </div>
          </div>`;
      }
    };

    // ==================== MAIN APP CONTROLLER ====================
    const App = {
      async init() {
        try {
          const session = localStorage.getItem('rw_session');
          if (session) {
            State.currentUser = JSON.parse(session);
            await App.loadData();
          }
        } catch (e) { console.error(e); }
        UI.render();
      },

      async loadData() {
        try {
          await Promise.all([Api.getActivities(), Api.getAttendances()]);
          UI.render(); 
        } catch (e) {
          console.error("Gagal memuat data", e);
        }
      },

      attachEvents() {
        document.getElementById('loginForm')?.addEventListener('submit', App.handlers.login);
        document.getElementById('registerForm')?.addEventListener('submit', App.handlers.register);
        document.getElementById('activityForm')?.addEventListener('submit', App.handlers.addActivity);

        document.getElementById('goToRegister')?.addEventListener('click', () => { State.currentView = 'register'; UI.render(); });
        document.getElementById('goToLogin')?.addEventListener('click', () => { State.currentView = 'login'; UI.render(); });
        document.getElementById('logoutBtn')?.addEventListener('click', App.handlers.logout);

        // Password Toggles
        document.getElementById('togglePassReg')?.addEventListener('click', () => Utils.togglePassword('regPassword', 'togglePassReg'));
        document.getElementById('togglePassConfirm')?.addEventListener('click', () => Utils.togglePassword('regConfirmPassword', 'togglePassConfirm'));

        const jabatanSelect = document.getElementById('regJabatan');
        const jabatanCustom = document.getElementById('regJabatanCustom');
        if(jabatanSelect && jabatanCustom) {
          jabatanSelect.addEventListener('change', (e) => {
            if(e.target.value === 'Lainnya') {
              jabatanCustom.classList.remove('hidden');
              jabatanCustom.focus();
            } else {
              jabatanCustom.classList.add('hidden');
            }
          });
        }

        // Admin Tabs
        document.querySelectorAll('.admin-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const target = e.target.dataset.tab;
            document.querySelectorAll('.admin-tab').forEach(t => {
              t.classList.remove('border-amber-500', 'text-amber-600');
              t.classList.add('border-transparent');
            });
            e.target.classList.remove('border-transparent');
            e.target.classList.add('border-amber-500', 'text-amber-600');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${target}`).classList.remove('hidden');
          });
        });

        // Modals
        document.getElementById('addActivityBtn')?.addEventListener('click', () => {
          document.getElementById('activityModal').classList.remove('hidden');
        });
        document.getElementById('closeActivityModal')?.addEventListener('click', () => {
          document.getElementById('activityModal').classList.add('hidden');
          document.getElementById('activityForm').reset();
        });

        document.querySelectorAll('[data-toggle]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const btnOrig = btn.textContent;
            btn.textContent = '...';
            await Api.toggleActivity(btn.dataset.toggle);
            await App.loadData();
          });
        });

        document.querySelectorAll('[data-delete]').forEach(btn => {
          btn.addEventListener('click', () => {
            State.temp.deleteActivityId = btn.dataset.delete;
            document.getElementById('deleteModal').classList.remove('hidden');
          });
        });

        document.getElementById('cancelDelete')?.addEventListener('click', () => {
          document.getElementById('deleteModal').classList.add('hidden');
        });

        document.getElementById('confirmDelete')?.addEventListener('click', async () => {
          await Api.deleteActivity(State.temp.deleteActivityId);
          document.getElementById('deleteModal').classList.add('hidden');
          await App.loadData();
        });

        // Attendance Flow
        document.querySelectorAll('[data-attend]').forEach(btn => {
          btn.addEventListener('click', () => App.handlers.openAttendanceModal(btn.dataset.attend));
        });

        document.getElementById('closeAttendanceModal')?.addEventListener('click', App.handlers.closeAttendanceModal);
        document.getElementById('captureBtn')?.addEventListener('click', App.handlers.capturePhoto);
        document.getElementById('retakeBtn')?.addEventListener('click', () => {
          document.getElementById('capturedImage').classList.add('hidden');
          document.getElementById('cameraVideo').classList.remove('hidden');
          document.getElementById('captureBtn').classList.remove('hidden');
          document.getElementById('retakeBtn').classList.add('hidden');
          State.temp.capturedPhoto = null;
          App.updateSubmitBtn();
        });
        
        document.getElementById('clearSignature')?.addEventListener('click', App.handlers.clearSignature);
        document.getElementById('refreshLocation')?.addEventListener('click', App.handlers.getLocation);
        document.getElementById('submitAttendance')?.addEventListener('click', App.handlers.submitAttendance);

        // Reports
        document.getElementById('generateReport')?.addEventListener('click', App.handlers.generateReport);
        document.getElementById('exportPdf')?.addEventListener('click', App.handlers.exportPdf);
      },

      updateSubmitBtn() {
        const btn = document.getElementById('submitAttendance');
        if (btn) {
          // Check all conditions individually
          const hasPhoto = !!State.temp.capturedPhoto;
          const hasLoc = !!State.temp.location;
          const hasSig = State.temp.hasSignature === true;

          const isComplete = hasPhoto && hasLoc && hasSig;

          btn.disabled = !isComplete;
        }
      },

      handlers: {
        async login(e) {
          e.preventDefault();
          const userIn = document.getElementById('loginUsername').value;
          const passIn = document.getElementById('loginPassword').value;
          const btn = document.getElementById('loginBtn');
          
          btn.disabled = true; btn.innerHTML = '<div class="loader mx-auto"></div>';

          try {
            let user;
            if(userIn === 'admin' && passIn === 'admin123') {
               user = { id: 'admin', username: 'admin', fullName: 'Administrator', role: 'admin' };
            } else {
               user = await Api.login(userIn, passIn);
            }
            State.currentUser = user;
            localStorage.setItem('rw_session', JSON.stringify(user));
            await App.loadData();
            Utils.showToast('Login Berhasil');
          } catch (err) {
            btn.disabled = false; btn.textContent = 'Masuk';
          }
        },

        async register(e) {
          e.preventDefault();
          
          const jabatanSelect = document.getElementById('regJabatan').value;
          const jabatanCustom = document.getElementById('regJabatanCustom').value;
          const finalJabatan = (jabatanSelect === 'Lainnya') ? jabatanCustom : jabatanSelect;

          if (!finalJabatan) {
            Utils.showToast('Mohon pilih atau isi jabatan', 'error');
            return;
          }

          const pass = document.getElementById('regPassword').value;
          const confirm = document.getElementById('regConfirmPassword').value;
          if (pass !== confirm) {
            Utils.showToast('Password dan konfirmasi password tidak cocok', 'error');
            return;
          }

          const btn = document.getElementById('registerBtn');
          const data = {
            fullName: document.getElementById('regFullName').value,
            rt: document.getElementById('regRt').value,
            jabatan: finalJabatan, 
            phone: document.getElementById('regPhone').value,
            username: document.getElementById('regUsername').value,
            password: pass
          };

          btn.disabled = true; btn.innerHTML = '<div class="loader mx-auto"></div>';

          try {
            await Api.register(data);
            Utils.showToast('Registrasi Berhasil');
            State.currentView = 'login';
            UI.render();
          } catch (err) {
            btn.disabled = false; btn.textContent = 'Daftar';
          }
        },

        logout() {
          State.currentUser = null;
          localStorage.removeItem('rw_session');
          State.currentView = 'login';
          UI.render();
          Utils.showToast('Keluar');
        },

        async addActivity(e) {
          e.preventDefault();
          const btn = document.querySelector('#activityForm button[type="submit"]');
          const data = {
            name: document.getElementById('actName').value,
            date: document.getElementById('actDate').value,
            time: document.getElementById('actTime').value,
            location: document.getElementById('actLocation').value
          };
          
          btn.disabled = true;
          try {
            await Api.addActivity(data);
            document.getElementById('activityModal').classList.add('hidden');
            document.getElementById('activityForm').reset();
            await App.loadData();
          } finally {
            btn.disabled = false;
          }
        },

        async openAttendanceModal(actId) {
          State.temp.selectedActivityId = actId;
          State.temp.capturedPhoto = null;
          State.temp.signatureData = null;
          State.temp.hasSignature = false; // Reset signature flag
          State.temp.location = null;
          
          const modal = document.getElementById('attendanceModal');
          modal.classList.remove('hidden');
          
          // Reset UI
          document.getElementById('capturedImage').classList.add('hidden');
          document.getElementById('cameraVideo').classList.remove('hidden');
          document.getElementById('captureBtn').classList.remove('hidden');
          document.getElementById('retakeBtn').classList.add('hidden');
          document.getElementById('locationStatus').textContent = '‚è≥ Mendeteksi lokasi...';
          
          // Force button disabled initially
          App.updateSubmitBtn();

          // Start Camera
          try {
            if (State.temp.videoStream) State.temp.videoStream.getTracks().forEach(track => track.stop());
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            State.temp.videoStream = stream;
            document.getElementById('cameraVideo').srcObject = stream;
          } catch (err) {
            Utils.showToast('Gagal akses kamera', 'error');
          }

          // Initialize Signature Pad immediately
          App.handlers.initSignaturePad();

          // Get Location
          App.handlers.getLocation();
        },

        closeAttendanceModal() {
          if (State.temp.videoStream) {
            State.temp.videoStream.getTracks().forEach(track => track.stop());
            State.temp.videoStream = null;
          }
          document.getElementById('attendanceModal').classList.add('hidden');
        },

        capturePhoto() {
          const video = document.getElementById('cameraVideo');
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0);
          
          const resizedCanvas = document.createElement('canvas');
          const maxSize = 300;
          let width = canvas.width;
          let height = canvas.height;
          if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
          else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
          resizedCanvas.width = width;
          resizedCanvas.height = height;
          resizedCanvas.getContext('2d').drawImage(canvas, 0, 0, width, height);

          State.temp.capturedPhoto = resizedCanvas.toDataURL('image/jpeg', 0.7);
          
          document.getElementById('capturedImage').src = State.temp.capturedPhoto;
          document.getElementById('capturedImage').classList.remove('hidden');
          document.getElementById('cameraVideo').classList.add('hidden');
          document.getElementById('captureBtn').classList.add('hidden');
          document.getElementById('retakeBtn').classList.remove('hidden');
          
          State.temp.videoStream.getTracks().forEach(track => track.stop());
          
          App.updateSubmitBtn();
        },

        initSignaturePad() {
          const canvas = document.getElementById('signatureCanvas');
          if(!canvas) return;
          const container = document.getElementById('sigContainer');
          
          // Set resolution strictly
          canvas.width = container.offsetWidth;
          canvas.height = 150; 
          
          const ctx = canvas.getContext('2d');
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";

          const getPos = (e) => {
             const rect = canvas.getBoundingClientRect();
             // Check for Touch
             if(e.touches && e.touches.length > 0) {
               return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
             }
             // Fallback for Mouse
             return { x: e.clientX - rect.left, y: e.clientY - rect.top };
          };

          const start = (e) => {
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
          };

          const move = (e) => {
            e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            // IMPORTANT: Force update state and button here
            State.temp.hasSignature = true;
            App.updateSubmitBtn();
          };

          const end = () => { };

          // Mouse Events
          canvas.addEventListener("mousedown", start);
          canvas.addEventListener("mousemove", move);
          canvas.addEventListener("mouseup", end);
          canvas.addEventListener("mouseout", end);

          // Touch Events
          canvas.addEventListener("touchstart", start);
          canvas.addEventListener("touchmove", move);
          canvas.addEventListener("touchend", end);
        },

        clearSignature() {
          const canvas = document.getElementById('signatureCanvas');
          if(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Reset state
            State.temp.hasSignature = false;
            App.updateSubmitBtn();
          }
        },

        async getLocation() {
          const status = document.getElementById('locationStatus');
          status.textContent = 'üîÑ Sedang mencari...';
          try {
            const loc = await Utils.getLocation();
            State.temp.location = loc;
            status.textContent = `üìç ${loc.name}`;
          } catch (err) {
            status.textContent = `‚ùå ${err}`;
            State.temp.location = null;
          }
          // Force update button state after location fetch
          App.updateSubmitBtn();
        },

        async submitAttendance() {
          if (!State.temp.capturedPhoto || !State.temp.location || !State.temp.hasSignature) return;
          
          const btn = document.getElementById('submitAttendance');
          btn.disabled = true; btn.textContent = 'Mengirim...';

          try {
            await Api.submitAttendance({
              activityId: State.temp.selectedActivityId,
              userId: State.currentUser.id, 
              userName: State.currentUser.fullName,
              userRt: State.currentUser.rt,
              photoData: State.temp.capturedPhoto,
              signatureData: document.getElementById('signatureCanvas').toDataURL(),
              location: State.temp.location
            });
            Utils.showToast('Absensi Berhasil!');
            App.handlers.closeAttendanceModal();
            await App.loadData(); 
          } catch (err) {
            btn.disabled = false; btn.textContent = 'Kirim Absensi';
          }
        },

        generateReport() {
          const actId = document.getElementById('reportActivity').value;
          if (!actId) return Utils.showToast('Pilih kegiatan dulu', 'error');

          const reportData = State.allAttendances.filter(a => a.activityId === actId);
          const tbody = document.getElementById('reportBody');
          
          tbody.innerHTML = reportData.map((d, i) => `
            <tr>
              <td class="p-2 border text-center">${i + 1}</td>
              <td class="p-2 border">${d.userFullName}</td>
              <td class="p-2 border">${d.userRt}</td>
              <td class="p-2 border">${d.attendanceTime.split('T')[1]?.substring(0,5)}</td>
            </tr>
          `).join('');
          
          document.getElementById('reportResult').classList.remove('hidden');
        },

        exportPdf() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const actName = document.getElementById('reportActivity').options[document.getElementById('reportActivity').selectedIndex].text;
          
          doc.text(`Laporan Absensi: ${actName}`, 14, 15);
          doc.autoTable({ html: '#reportTable', startY: 20 });
          doc.save('laporan-absensi.pdf');
        }
      }
    };

    App.init();
  </script>
</body>
</html>
