<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Kegiatan RW 01</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
    }
    .card-glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    .btn-primary {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(30, 58, 95, 0.3);
    }
    .input-field {
      transition: all 0.3s ease;
    }
    .input-field:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .nav-item {
      transition: all 0.2s ease;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    .table-row:hover {
      background: rgba(245, 158, 11, 0.05);
    }
    .camera-container {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
    }
    .camera-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
    }
    .face-guide {
      width: 200px;
      height: 250px;
      border: 3px dashed #f59e0b;
      border-radius: 50% 50% 45% 45%;
    }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-aktif {
      background: #d1fae5;
      color: #059669;
    }
    .status-selesai {
      background: #e5e7eb;
      color: #6b7280;
    }
    .status-dibatalkan {
      background: #fee2e2;
      color: #dc2626;
    }
    .toast {
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
    }
    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .modal-overlay {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .data-tab:hover {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    .data-tab.active {
      border-bottom-color: #f59e0b;
      color: #f59e0b;
      font-weight: 600;
    }
    .data-table {
      font-size: 0.875rem;
    }
    .data-table th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 10;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-100">
  <div id="app" class="h-full overflow-auto"><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50"></div><!-- Main Content -->
   <div id="main-content"></div><!-- Modal Container -->
   <div id="modal-container"></div>
  </div>
  <script>
    // Default Config
    const defaultConfig = {
      app_title: 'Absensi Kegiatan RW 01',
      rw_number: '05',
      kelurahan: 'Sukamaju',
      primary_color: '#1e3a5f',
      secondary_color: '#f59e0b',
      background_color: '#f3f4f6',
      text_color: '#1f2937',
      surface_color: '#ffffff'
    };

    // State
    let config = { ...defaultConfig };
    let currentView = 'home';
    let currentUser = null;
    let isAdmin = false;
    let users = [];
    let activities = [];
    let attendances = [];
    let videoStream = null;
    let editingActivity = null;
    let currentDataTab = 'users';

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        users = data.filter(d => d.type === 'user');
        activities = data.filter(d => d.type === 'activity');
        attendances = data.filter(d => d.type === 'attendance');
        renderCurrentView();
      }
    };

    // Initialize SDKs
    async function initApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            renderCurrentView();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }},
              { get: () => cfg.surface_color || defaultConfig.surface_color, set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }},
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }},
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }},
              { get: () => cfg.secondary_color || defaultConfig.secondary_color, set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }}
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['rw_number', cfg.rw_number || defaultConfig.rw_number],
            ['kelurahan', cfg.kelurahan || defaultConfig.kelurahan]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          showToast('Gagal menginisialisasi database', 'error');
        }
      }

      renderCurrentView();
    }

    // Toast Notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Navigation
    function navigate(view, data = null) {
      stopCamera();
      currentView = view;
      if (data) {
        if (data.user) currentUser = data.user;
        if (data.admin !== undefined) isAdmin = data.admin;
        if (data.activity) editingActivity = data.activity;
      }
      renderCurrentView();
    }

    function logout() {
      currentUser = null;
      isAdmin = false;
      navigate('home');
    }

    // Render Functions
    function renderCurrentView() {
      const content = document.getElementById('main-content');
      const bgColor = config.background_color || defaultConfig.background_color;
      
      switch(currentView) {
        case 'home':
          content.innerHTML = renderHome();
          break;
        case 'login':
          content.innerHTML = renderLogin();
          break;
        case 'register':
          content.innerHTML = renderRegister();
          break;
        case 'admin-dashboard':
          content.innerHTML = renderAdminDashboard();
          break;
        case 'user-dashboard':
          content.innerHTML = renderUserDashboard();
          break;
        case 'attendance':
          content.innerHTML = renderAttendance();
          setTimeout(startCamera, 100);
          break;
        case 'activity-form':
          content.innerHTML = renderActivityForm();
          break;
        default:
          content.innerHTML = renderHome();
      }
      
      document.body.style.backgroundColor = bgColor;
    }

    function renderHome() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const appTitle = config.app_title || defaultConfig.app_title;
      const rwNumber = config.rw_number || defaultConfig.rw_number;
      const kelurahan = config.kelurahan || defaultConfig.kelurahan;

      const activeActivities = activities.filter(a => a.activity_status === 'aktif');

      return `
        <div class="min-h-full gradient-bg" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
          <div class="container mx-auto px-4 py-8">
            <!-- Header -->
            <div class="text-center mb-12">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: ${secondaryColor};">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
              <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">${appTitle}</h1>
              <p class="text-gray-300 text-lg">RW ${rwNumber} - Kelurahan ${kelurahan}</p>
            </div>

            <!-- Single Login Card -->
            <div class="max-w-md mx-auto mb-12">
              <div class="card-glass rounded-2xl p-6 shadow-xl" style="background: ${surfaceColor};">
                <div class="text-center">
                  <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                    </svg>
                  </div>
                  <h2 class="text-xl font-bold mb-2" style="color: ${textColor};">Portal Masuk</h2>
                  <p class="text-gray-500 mb-4">Masuk sebagai Warga atau Admin</p>
                  <button onclick="navigate('login')" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl mb-3">
                    Masuk ke Portal
                  </button>
                  <p class="text-sm text-gray-500">
                    Belum terdaftar? 
                    <button onclick="navigate('register')" class="font-semibold hover:underline" style="color: ${secondaryColor};">Daftar di sini</button>
                  </p>
                </div>
              </div>
            </div>

            <!-- Active Activities -->
            ${activeActivities.length > 0 ? `
              <div class="max-w-2xl mx-auto">
                <h3 class="text-white text-xl font-semibold mb-4 text-center">üìÖ Kegiatan Aktif</h3>
                <div class="space-y-3">
                  ${activeActivities.map(act => `
                    <div class="card-glass rounded-xl p-4 flex items-center justify-between" style="background: ${surfaceColor};">
                      <div>
                        <h4 class="font-semibold" style="color: ${textColor};">${act.activity_name}</h4>
                        <p class="text-sm text-gray-500">${formatDate(act.activity_date)} ‚Ä¢ ${act.activity_location}</p>
                      </div>
                      <span class="status-badge status-aktif">Aktif</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    let loginMode = 'warga'; // 'warga' or 'admin'

    function renderLogin() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;

      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
          <div class="card-glass rounded-2xl p-8 w-full max-w-md shadow-xl" style="background: ${surfaceColor};">
            <button onclick="navigate('home')" class="mb-6 flex items-center text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Kembali
            </button>
            
            <!-- Role Toggle -->
            <div class="flex gap-2 mb-6">
              <button onclick="switchLoginMode('warga')" id="btn-warga" class="flex-1 py-3 px-4 rounded-xl font-semibold transition ${loginMode === 'warga' ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}" style="${loginMode === 'warga' ? `background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);` : ''}">
                üë§ Warga
              </button>
              <button onclick="switchLoginMode('admin')" id="btn-admin" class="flex-1 py-3 px-4 rounded-xl font-semibold transition ${loginMode === 'admin' ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}" style="${loginMode === 'admin' ? `background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);` : ''}">
                ‚öôÔ∏è Admin
              </button>
            </div>

            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" id="login-icon" style="background: linear-gradient(135deg, ${loginMode === 'warga' ? secondaryColor + ' 0%, #d97706' : primaryColor + ' 0%, #0d1b2a'} 100%);">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="icon-svg">
                  ${loginMode === 'warga' ? 
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>' :
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>'
                  }
                </svg>
              </div>
              <h2 class="text-2xl font-bold" style="color: ${textColor};" id="login-title">${loginMode === 'warga' ? 'Masuk Warga' : 'Masuk Admin'}</h2>
              <p class="text-gray-500" id="login-subtitle">${loginMode === 'warga' ? 'Masukkan NIK untuk melanjutkan' : 'Masukkan kredensial admin'}</p>
            </div>

            <form id="login-form" onsubmit="handleUnifiedLogin(event)">
              <!-- Warga Fields -->
              <div id="warga-fields" class="${loginMode === 'warga' ? '' : 'hidden'}">
                <div class="mb-4">
                  <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="login-username">Username</label>
                  <input type="text" id="login-username" name="username"
                    class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                    placeholder="Masukkan username Anda" ${loginMode === 'warga' ? 'required' : ''}>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="login-password">Password</label>
                  <input type="password" id="login-password" name="password"
                    class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                    placeholder="Masukkan password" ${loginMode === 'warga' ? 'required' : ''}>
                </div>
              </div>

              <!-- Admin Fields -->
              <div id="admin-fields" class="${loginMode === 'admin' ? '' : 'hidden'}">
                <div class="mb-4">
                  <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="admin-username">Username</label>
                  <input type="text" id="admin-username" name="username"
                    class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                    placeholder="Username admin" ${loginMode === 'admin' ? 'required' : ''}>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="admin-password">Password</label>
                  <input type="password" id="admin-password" name="password"
                    class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                    placeholder="Password" ${loginMode === 'admin' ? 'required' : ''}>
                </div>
                <p class="mb-4 text-xs text-gray-400 text-center">Demo: admin / admin123</p>
              </div>

              <button type="submit" id="login-btn" class="w-full text-white font-semibold py-3 px-6 rounded-xl ${loginMode === 'warga' ? 'btn-primary' : 'btn-secondary'}">
                Masuk
              </button>
            </form>

            <p class="mt-6 text-center text-sm text-gray-500" id="register-link">
              Belum terdaftar? 
              <button onclick="navigate('register')" class="font-semibold hover:underline" style="color: ${secondaryColor};">Daftar di sini</button>
            </p>
          </div>
        </div>
      `;
    }

    function switchLoginMode(mode) {
      loginMode = mode;
      renderCurrentView();
    }

    async function handleUnifiedLogin(e) {
      e.preventDefault();
      const btn = document.getElementById('login-btn');
      
      btn.disabled = true;
      btn.textContent = 'Memproses...';

      if (loginMode === 'warga') {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const user = users.find(u => u.username === username && u.password === password);
        
        if (user) {
          currentUser = user;
          showToast(`Selamat datang, ${user.name}!`);
          navigate('user-dashboard', { user });
        } else {
          showToast('Username atau password salah!', 'error');
          btn.disabled = false;
          btn.textContent = 'Masuk';
        }
      } else {
        const username = document.getElementById('admin-username').value.trim();
        const password = document.getElementById('admin-password').value;
        
        if (username === 'admin' && password === 'admin123') {
          isAdmin = true;
          showToast('Login admin berhasil!');
          navigate('admin-dashboard', { admin: true });
        } else {
          showToast('Username atau password salah!', 'error');
          btn.disabled = false;
          btn.textContent = 'Masuk';
        }
      }
    }

    function renderRegister() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;

      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
          <div class="card-glass rounded-2xl p-8 w-full max-w-md shadow-xl" style="background: ${surfaceColor};">
            <button onclick="navigate('home')" class="mb-6 flex items-center text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Kembali
            </button>
            
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                </svg>
              </div>
              <h2 class="text-2xl font-bold" style="color: ${textColor};">Pendaftaran Warga</h2>
              <p class="text-gray-500">Lengkapi data diri Anda</p>
            </div>

            <form id="register-form" onsubmit="handleRegister(event)">
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-name">Nama Lengkap</label>
                <input type="text" id="reg-name" name="name" required
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Masukkan nama lengkap">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-username">Username</label>
                <input type="text" id="reg-username" name="username" required minlength="4"
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Masukkan username (min. 4 karakter)">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-password">Password</label>
                <input type="password" id="reg-password" name="password" required minlength="6"
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Masukkan password (min. 6 karakter)">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-confirm-password">Confirm Password</label>
                <input type="password" id="reg-confirm-password" name="confirm_password" required minlength="6"
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Ketik ulang password">
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-rt-select">RT / SATUAN / Lainnya</label>
                <select id="reg-rt-select" name="rt_select" required onchange="toggleRtInput()"
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none">
                  <option value="">Pilih RT, SATUAN, atau Lainnya</option>
                  ${[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].map(rt => `<option value="RT ${rt.toString().padStart(2,'0')}">RT ${rt.toString().padStart(2,'0')}</option>`).join('')}
                  <option value="lainnya">Lainnya (ketik manual)</option>
                </select>
              </div>
              
              <div id="reg-rt-custom-container" class="mb-4 hidden">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="reg-rt-custom">Ketik RT / SATUAN / Lainnya</label>
                <input type="text" id="reg-rt-custom" name="rt_custom"
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Contoh: RT 17, Pengurus, dll">
              </div>
              
              <!-- Camera for Photo -->
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};">Foto Wajah</label>
                <div id="reg-camera-container" class="camera-container bg-gray-900 rounded-xl overflow-hidden" style="height: 250px;">
                  <video id="reg-video" autoplay playsinline class="w-full h-full object-cover"></video>
                  <div class="camera-overlay" id="reg-camera-overlay">
                    <div class="face-guide"></div>
                  </div>
                </div>
                <canvas id="reg-canvas" class="hidden"></canvas>
                <input type="hidden" id="reg-photo" name="photo">
                <div class="flex gap-2 mt-3">
                  <button type="button" onclick="startRegisterCamera()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                    üì∑ Buka Kamera
                  </button>
                  <button type="button" onclick="captureRegisterPhoto()" class="flex-1 text-white font-medium py-2 px-4 rounded-lg transition" style="background: ${secondaryColor};">
                    üì∏ Ambil Foto
                  </button>
                </div>
                <div id="reg-photo-preview" class="mt-3 hidden">
                  <img id="reg-preview-img" class="w-full rounded-xl" alt="Preview foto">
                </div>
              </div>

              <button type="submit" id="register-btn" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl">
                Daftar Sekarang
              </button>
            </form>

            <p class="mt-6 text-center text-sm text-gray-500">
              Sudah terdaftar? 
              <button onclick="navigate('login')" class="font-semibold hover:underline" style="color: ${secondaryColor};">Masuk di sini</button>
            </p>
          </div>
        </div>
      `;
    }

    function toggleRtInput() {
      const select = document.getElementById('reg-rt-select');
      const customContainer = document.getElementById('reg-rt-custom-container');
      const customInput = document.getElementById('reg-rt-custom');
      
      if (select.value === 'lainnya') {
        customContainer.classList.remove('hidden');
        customInput.required = true;
      } else {
        customContainer.classList.add('hidden');
        customInput.required = false;
        customInput.value = '';
      }
    }

    async function startRegisterCamera() {
      try {
        const video = document.getElementById('reg-video');
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: 640, height: 480 } 
        });
        video.srcObject = videoStream;
        document.getElementById('reg-camera-overlay').style.display = 'flex';
        showToast('Kamera aktif! Posisikan wajah di dalam bingkai.');
      } catch (err) {
        showToast('Gagal mengakses kamera. Pastikan izin kamera diberikan.', 'error');
      }
    }

    function captureRegisterPhoto() {
      const video = document.getElementById('reg-video');
      const canvas = document.getElementById('reg-canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 320;
      canvas.height = 240;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const photoData = canvas.toDataURL('image/jpeg', 0.7);
      document.getElementById('reg-photo').value = photoData;
      
      const preview = document.getElementById('reg-photo-preview');
      document.getElementById('reg-preview-img').src = photoData;
      preview.classList.remove('hidden');
      
      document.getElementById('reg-camera-overlay').style.display = 'none';
      showToast('Foto berhasil diambil!');
    }

    async function handleRegister(e) {
      e.preventDefault();
      const btn = document.getElementById('register-btn');
      const name = document.getElementById('reg-name').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm-password').value;
      const rtSelect = document.getElementById('reg-rt-select').value;
      const rtCustom = document.getElementById('reg-rt-custom').value.trim();
      const photo = document.getElementById('reg-photo').value;

      // Validation
      if (password !== confirmPassword) {
        showToast('Password dan Confirm Password tidak sama!', 'error');
        return;
      }

      if (!photo) {
        showToast('Silakan ambil foto wajah terlebih dahulu', 'error');
        return;
      }

      if (users.length >= 999) {
        showToast('Batas maksimum pendaftaran tercapai', 'error');
        return;
      }

      if (users.find(u => u.username === username)) {
        showToast('Username sudah digunakan!', 'error');
        return;
      }

      // Determine RT value
      const rtValue = rtSelect === 'lainnya' ? rtCustom : rtSelect;

      btn.disabled = true;
      btn.textContent = 'Mendaftarkan...';

      const result = await window.dataSdk.create({
        type: 'user',
        name,
        username,
        password,
        rt: rtValue,
        photo,
        registered_at: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('Pendaftaran berhasil! Silakan masuk.');
        stopCamera();
        navigate('login');
      } else {
        showToast('Gagal mendaftar. Silakan coba lagi.', 'error');
        btn.disabled = false;
        btn.textContent = 'Daftar Sekarang';
      }
    }



    // Data Table Functions
    function switchDataTab(tab) {
      currentDataTab = tab;
      renderDataTable();
    }

    function renderDataTable() {
      const container = document.getElementById('data-table-container');
      const textColor = config.text_color || defaultConfig.text_color;
      
      // Update tab styles
      document.querySelectorAll('.data-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`tab-${currentDataTab}`).classList.add('active');

      if (currentDataTab === 'users') {
        container.innerHTML = renderUsersTable(textColor);
      } else if (currentDataTab === 'activities') {
        container.innerHTML = renderActivitiesTable(textColor);
      } else if (currentDataTab === 'attendances') {
        container.innerHTML = renderAttendancesTable(textColor);
      }
    }

    function renderUsersTable(textColor) {
      if (users.length === 0) {
        return `<div class="text-center py-8 text-gray-400">Belum ada data warga</div>`;
      }
      return `
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full data-table">
            <thead>
              <tr class="border-b-2" style="color: ${textColor};">
                <th class="text-left py-3 px-3 font-semibold">Nama Lengkap</th>
                <th class="text-left py-3 px-3 font-semibold">Username</th>
                <th class="text-left py-3 px-3 font-semibold">RT</th>
                <th class="text-left py-3 px-3 font-semibold">Terdaftar</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr class="border-b hover:bg-gray-50" style="color: ${textColor};">
                  <td class="py-2 px-3">${user.name}</td>
                  <td class="py-2 px-3">@${user.username}</td>
                  <td class="py-2 px-3">${user.rt}</td>
                  <td class="py-2 px-3">${formatDateTime(user.registered_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderActivitiesTable(textColor) {
      if (activities.length === 0) {
        return `<div class="text-center py-8 text-gray-400">Belum ada data kegiatan</div>`;
      }
      return `
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full data-table">
            <thead>
              <tr class="border-b-2" style="color: ${textColor};">
                <th class="text-left py-3 px-3 font-semibold">Nama Kegiatan</th>
                <th class="text-left py-3 px-3 font-semibold">Tanggal</th>
                <th class="text-left py-3 px-3 font-semibold">Lokasi</th>
                <th class="text-left py-3 px-3 font-semibold">Status</th>
                <th class="text-left py-3 px-3 font-semibold">Dibuat</th>
              </tr>
            </thead>
            <tbody>
              ${activities.map(act => `
                <tr class="border-b hover:bg-gray-50" style="color: ${textColor};">
                  <td class="py-2 px-3">${act.activity_name}</td>
                  <td class="py-2 px-3">${formatDate(act.activity_date)}</td>
                  <td class="py-2 px-3">${act.activity_location}</td>
                  <td class="py-2 px-3"><span class="status-badge status-${act.activity_status}">${act.activity_status}</span></td>
                  <td class="py-2 px-3">${formatDateTime(act.created_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderAttendancesTable(textColor) {
      if (attendances.length === 0) {
        return `<div class="text-center py-8 text-gray-400">Belum ada data absensi</div>`;
      }
      return `
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full data-table">
            <thead>
              <tr class="border-b-2" style="color: ${textColor};">
                <th class="text-left py-3 px-3 font-semibold">Username</th>
                <th class="text-left py-3 px-3 font-semibold">Nama Warga</th>
                <th class="text-left py-3 px-3 font-semibold">Kegiatan</th>
                <th class="text-left py-3 px-3 font-semibold">Waktu Absensi</th>
              </tr>
            </thead>
            <tbody>
              ${attendances.map(att => {
                const user = users.find(u => u.username === att.user_username);
                return `
                  <tr class="border-b hover:bg-gray-50" style="color: ${textColor};">
                    <td class="py-2 px-3">@${att.user_username}</td>
                    <td class="py-2 px-3">${user ? user.name : '-'}</td>
                    <td class="py-2 px-3">${att.activity_name}</td>
                    <td class="py-2 px-3">${formatDateTime(att.attendance_time)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Download Functions
    function downloadTableData(type) {
      let data = [];
      let filename = '';
      
      if (type === 'users') {
        data = users.map(u => ({
          'Nama Lengkap': u.name,
          'Username': u.username,
          'RT': u.rt,
          'Tanggal Daftar': formatDateTime(u.registered_at)
        }));
        filename = 'data_warga.csv';
      } else if (type === 'activities') {
        data = activities.map(a => ({
          'Nama Kegiatan': a.activity_name,
          'Tanggal': a.activity_date,
          'Lokasi': a.activity_location,
          'Status': a.activity_status,
          'Jumlah Peserta': attendances.filter(att => att.activity_name === a.activity_name).length,
          'Dibuat': formatDateTime(a.created_at)
        }));
        filename = 'data_kegiatan.csv';
      } else if (type === 'attendances') {
        data = attendances.map(att => {
          const user = users.find(u => u.username === att.user_username);
          return {
            'Username': att.user_username,
            'Nama Warga': user ? user.name : '-',
            'RT': user ? user.rt : '-',
            'Kegiatan': att.activity_name,
            'Waktu Absensi': formatDateTime(att.attendance_time)
          };
        });
        filename = 'data_absensi.csv';
      }

      if (data.length === 0) {
        showToast('Tidak ada data untuk diunduh', 'error');
        return;
      }

      const csv = convertToCSV(data);
      downloadCSV(csv, filename);
      showToast(`Data berhasil diunduh: ${filename}`);
    }

    function convertToCSV(data) {
      const headers = Object.keys(data[0]);
      const csvRows = [];
      
      // Add headers
      csvRows.push(headers.join(','));
      
      // Add data rows
      for (const row of data) {
        const values = headers.map(header => {
          const value = row[header];
          // Escape quotes and wrap in quotes if contains comma
          const escaped = String(value).replace(/"/g, '""');
          return escaped.includes(',') ? `"${escaped}"` : escaped;
        });
        csvRows.push(values.join(','));
      }
      
      return csvRows.join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function renderAdminDashboard() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const bgColor = config.background_color || defaultConfig.background_color;
      const appTitle = config.app_title || defaultConfig.app_title;

      const totalUsers = users.length;
      const totalActivities = activities.length;
      const activeActivities = activities.filter(a => a.activity_status === 'aktif').length;
      const totalAttendances = attendances.length;

      return `
        <div class="min-h-full" style="background: ${bgColor};">
          <!-- Header -->
          <div class="gradient-bg text-white px-4 py-6" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
            <div class="container mx-auto flex justify-between items-center">
              <div>
                <h1 class="text-xl font-bold">Dashboard Admin</h1>
                <p class="text-sm opacity-80">${appTitle}</p>
              </div>
              <button onclick="logout()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Keluar
              </button>
            </div>
          </div>

          <div class="container mx-auto px-4 py-6">
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
              <div class="rounded-xl p-4 text-white" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
                <p class="text-sm opacity-80">Total Warga</p>
                <p class="text-3xl font-bold">${totalUsers}</p>
              </div>
              <div class="rounded-xl p-4 text-white" style="background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);">
                <p class="text-sm opacity-80">Total Kegiatan</p>
                <p class="text-3xl font-bold">${totalActivities}</p>
              </div>
              <div class="rounded-xl p-4" style="background: ${surfaceColor}; color: ${textColor};">
                <p class="text-sm opacity-60">Kegiatan Aktif</p>
                <p class="text-3xl font-bold" style="color: #059669;">${activeActivities}</p>
              </div>
              <div class="rounded-xl p-4" style="background: ${surfaceColor}; color: ${textColor};">
                <p class="text-sm opacity-60">Total Absensi</p>
                <p class="text-3xl font-bold">${totalAttendances}</p>
              </div>
            </div>

            <!-- Activities Section -->
            <div class="rounded-2xl shadow-lg p-6 mb-8" style="background: ${surfaceColor};">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" style="color: ${textColor};">üìÖ Kelola Kegiatan</h2>
                <button onclick="navigate('activity-form')" class="btn-primary text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                  Tambah Kegiatan
                </button>
              </div>

              ${activities.length === 0 ? `
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <p>Belum ada kegiatan</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b" style="color: ${textColor};">
                        <th class="text-left py-3 px-4 font-semibold">Nama Kegiatan</th>
                        <th class="text-left py-3 px-4 font-semibold">Tanggal</th>
                        <th class="text-left py-3 px-4 font-semibold">Lokasi</th>
                        <th class="text-left py-3 px-4 font-semibold">Status</th>
                        <th class="text-left py-3 px-4 font-semibold">Absensi</th>
                        <th class="text-center py-3 px-4 font-semibold">Aksi</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${activities.map(act => {
                        const actAttendances = attendances.filter(a => a.activity_name === act.activity_name);
                        return `
                          <tr class="table-row border-b" style="color: ${textColor};">
                            <td class="py-3 px-4 font-medium">${act.activity_name}</td>
                            <td class="py-3 px-4">${formatDate(act.activity_date)}</td>
                            <td class="py-3 px-4">${act.activity_location}</td>
                            <td class="py-3 px-4">
                              <span class="status-badge status-${act.activity_status}">${act.activity_status.charAt(0).toUpperCase() + act.activity_status.slice(1)}</span>
                            </td>
                            <td class="py-3 px-4">${actAttendances.length} orang</td>
                            <td class="py-3 px-4 text-center">
                              <div class="flex justify-center gap-2">
                                <button onclick="editActivity('${act.__backendId}')" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Edit">
                                  <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                  </svg>
                                </button>
                                <button onclick="confirmDeleteActivity('${act.__backendId}')" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Hapus">
                                  <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                  </svg>
                                </button>
                              </div>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>

            <!-- Data Tables Section -->
            <div class="rounded-2xl shadow-lg p-6 mb-8" style="background: ${surfaceColor};">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" style="color: ${textColor};">üìä Database & Export Data</h2>
                <div class="flex gap-2">
                  <button onclick="downloadTableData('users')" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export Warga
                  </button>
                  <button onclick="downloadTableData('activities')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export Kegiatan
                  </button>
                  <button onclick="downloadTableData('attendances')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export Absensi
                  </button>
                </div>
              </div>

              <!-- Tabs -->
              <div class="flex gap-2 mb-4 border-b">
                <button onclick="switchDataTab('users')" id="tab-users" class="data-tab px-4 py-2 font-medium transition border-b-2 border-transparent" style="color: ${textColor};">
                  üë• Warga (${totalUsers})
                </button>
                <button onclick="switchDataTab('activities')" id="tab-activities" class="data-tab px-4 py-2 font-medium transition border-b-2 border-transparent" style="color: ${textColor};">
                  üìÖ Kegiatan (${totalActivities})
                </button>
                <button onclick="switchDataTab('attendances')" id="tab-attendances" class="data-tab px-4 py-2 font-medium transition border-b-2 border-transparent" style="color: ${textColor};">
                  ‚úÖ Absensi (${totalAttendances})
                </button>
              </div>

              <!-- Table Container -->
              <div id="data-table-container" class="overflow-x-auto">
                <!-- Tables will be rendered here -->
              </div>
            </div>

            <!-- Users Section -->
            <div class="rounded-2xl shadow-lg p-6" style="background: ${surfaceColor};">
              <h2 class="text-xl font-bold mb-6" style="color: ${textColor};">üë• Kartu Warga Terdaftar</h2>
              
              ${users.length === 0 ? `
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  <p>Belum ada warga terdaftar</p>
                </div>
              ` : `
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  ${users.map(user => `
                    <div class="border rounded-xl p-4 flex items-center gap-4">
                      <img src="${user.photo || 'data:image/svg+xml,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 viewBox%3D%220 0 24 24%22 fill%3D%22%23ccc%22%3E%3Cpath d%3D%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z%22%2F%3E%3C%2Fsvg%3E'}" 
                        class="w-14 h-14 rounded-full object-cover border-2" style="border-color: ${secondaryColor};" alt="${user.name}">
                      <div class="flex-1 min-w-0">
                        <p class="font-semibold truncate" style="color: ${textColor};">${user.name}</p>
                        <p class="text-sm text-gray-500">@${user.username}</p>
                        <p class="text-xs text-gray-400">${user.rt}</p>
                      </div>
                      <button onclick="confirmDeleteUser('${user.__backendId}')" class="p-2 hover:bg-red-50 rounded-lg transition" title="Hapus">
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      
      // Render data table after DOM is ready
      setTimeout(renderDataTable, 100);
    }

    function renderActivityForm() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;

      const isEdit = editingActivity !== null;
      const act = isEdit ? activities.find(a => a.__backendId === editingActivity) : null;

      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
          <div class="card-glass rounded-2xl p-8 w-full max-w-md shadow-xl" style="background: ${surfaceColor};">
            <button onclick="editingActivity = null; navigate('admin-dashboard')" class="mb-6 flex items-center text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Kembali
            </button>
            
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
              <h2 class="text-2xl font-bold" style="color: ${textColor};">${isEdit ? 'Edit Kegiatan' : 'Tambah Kegiatan Baru'}</h2>
            </div>

            <form id="activity-form" onsubmit="handleActivitySubmit(event)">
              <input type="hidden" id="activity-id" value="${isEdit ? act.__backendId : ''}">
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="activity-name">Nama Kegiatan</label>
                <input type="text" id="activity-name" name="name" required
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Contoh: Kerja Bakti" value="${isEdit ? act.activity_name : ''}">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="activity-date">Tanggal</label>
                <input type="date" id="activity-date" name="date" required
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  value="${isEdit ? act.activity_date : ''}">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="activity-location">Lokasi</label>
                <input type="text" id="activity-location" name="location" required
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none"
                  placeholder="Contoh: Lapangan RT 03" value="${isEdit ? act.activity_location : ''}">
              </div>
              <div class="mb-6">
                <label class="block text-sm font-medium mb-2" style="color: ${textColor};" for="activity-status">Status</label>
                <select id="activity-status" name="status" required
                  class="input-field w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none">
                  <option value="aktif" ${isEdit && act.activity_status === 'aktif' ? 'selected' : ''}>Aktif</option>
                  <option value="selesai" ${isEdit && act.activity_status === 'selesai' ? 'selected' : ''}>Selesai</option>
                  <option value="dibatalkan" ${isEdit && act.activity_status === 'dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                </select>
              </div>
              <button type="submit" id="activity-btn" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl">
                ${isEdit ? 'Simpan Perubahan' : 'Tambah Kegiatan'}
              </button>
            </form>
          </div>
        </div>
      `;
    }

    async function handleActivitySubmit(e) {
      e.preventDefault();
      const btn = document.getElementById('activity-btn');
      const id = document.getElementById('activity-id').value;
      const name = document.getElementById('activity-name').value.trim();
      const date = document.getElementById('activity-date').value;
      const location = document.getElementById('activity-location').value.trim();
      const status = document.getElementById('activity-status').value;

      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      let result;
      if (id) {
        const existing = activities.find(a => a.__backendId === id);
        result = await window.dataSdk.update({
          ...existing,
          activity_name: name,
          activity_date: date,
          activity_location: location,
          activity_status: status
        });
      } else {
        if (activities.length >= 999) {
          showToast('Batas maksimum kegiatan tercapai', 'error');
          btn.disabled = false;
          btn.textContent = 'Tambah Kegiatan';
          return;
        }
        result = await window.dataSdk.create({
          type: 'activity',
          activity_name: name,
          activity_date: date,
          activity_location: location,
          activity_status: status,
          created_at: new Date().toISOString()
        });
      }

      if (result.isOk) {
        showToast(id ? 'Kegiatan berhasil diperbarui!' : 'Kegiatan berhasil ditambahkan!');
        editingActivity = null;
        navigate('admin-dashboard');
      } else {
        showToast('Gagal menyimpan kegiatan', 'error');
        btn.disabled = false;
        btn.textContent = id ? 'Simpan Perubahan' : 'Tambah Kegiatan';
      }
    }

    function editActivity(id) {
      editingActivity = id;
      navigate('activity-form');
    }

    function confirmDeleteActivity(id) {
      const modal = document.getElementById('modal-container');
      const act = activities.find(a => a.__backendId === id);
      modal.innerHTML = `
        <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Kegiatan?</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus kegiatan "<strong>${act.activity_name}</strong>"?</p>
            <div class="flex gap-3">
              <button onclick="closeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                Batal
              </button>
              <button onclick="deleteActivity('${id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">
                Hapus
              </button>
            </div>
          </div>
        </div>
      `;
    }

    async function deleteActivity(id) {
      const act = activities.find(a => a.__backendId === id);
      const result = await window.dataSdk.delete(act);
      if (result.isOk) {
        showToast('Kegiatan berhasil dihapus');
      } else {
        showToast('Gagal menghapus kegiatan', 'error');
      }
      closeModal();
    }

    function confirmDeleteUser(id) {
      const modal = document.getElementById('modal-container');
      const user = users.find(u => u.__backendId === id);
      modal.innerHTML = `
        <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Warga?</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data "<strong>${user.name}</strong>"?</p>
            <div class="flex gap-3">
              <button onclick="closeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                Batal
              </button>
              <button onclick="deleteUser('${id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">
                Hapus
              </button>
            </div>
          </div>
        </div>
      `;
    }

    async function deleteUser(id) {
      const user = users.find(u => u.__backendId === id);
      const result = await window.dataSdk.delete(user);
      if (result.isOk) {
        showToast('Data warga berhasil dihapus');
      } else {
        showToast('Gagal menghapus data warga', 'error');
      }
      closeModal();
    }

    function closeModal() {
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderUserDashboard() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const bgColor = config.background_color || defaultConfig.background_color;
      const appTitle = config.app_title || defaultConfig.app_title;

      const activeActivities = activities.filter(a => a.activity_status === 'aktif');
      const userAttendances = attendances.filter(a => a.user_username === currentUser.username);

      return `
        <div class="min-h-full" style="background: ${bgColor};">
          <!-- Header -->
          <div class="gradient-bg text-white px-4 py-6" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
            <div class="container mx-auto flex justify-between items-center">
              <div class="flex items-center gap-4">
                <img src="${currentUser.photo || 'data:image/svg+xml,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 viewBox%3D%220 0 24 24%22 fill%3D%22%23fff%22%3E%3Cpath d%3D%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z%22%2F%3E%3C%2Fsvg%3E'}" 
                  class="w-12 h-12 rounded-full object-cover border-2 border-white/50" alt="${currentUser.name}">
                <div>
                  <p class="font-bold">${currentUser.name}</p>
                  <p class="text-sm opacity-80">RT ${currentUser.rt}</p>
                </div>
              </div>
              <button onclick="logout()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Keluar
              </button>
            </div>
          </div>

          <div class="container mx-auto px-4 py-6">
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4 mb-8">
              <div class="rounded-xl p-4 text-white" style="background: linear-gradient(135deg, ${secondaryColor} 0%, #d97706 100%);">
                <p class="text-sm opacity-80">Kegiatan Diikuti</p>
                <p class="text-3xl font-bold">${userAttendances.length}</p>
              </div>
              <div class="rounded-xl p-4" style="background: ${surfaceColor}; color: ${textColor};">
                <p class="text-sm opacity-60">Kegiatan Aktif</p>
                <p class="text-3xl font-bold" style="color: #059669;">${activeActivities.length}</p>
              </div>
            </div>

            <!-- Active Activities -->
            <div class="rounded-2xl shadow-lg p-6 mb-8" style="background: ${surfaceColor};">
              <h2 class="text-xl font-bold mb-6" style="color: ${textColor};">üìÖ Kegiatan Aktif</h2>
              
              ${activeActivities.length === 0 ? `
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <p>Tidak ada kegiatan aktif saat ini</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${activeActivities.map(act => {
                    const alreadyAttended = userAttendances.find(a => a.activity_name === act.activity_name);
                    return `
                      <div class="border rounded-xl p-4">
                        <div class="flex justify-between items-start mb-3">
                          <div>
                            <h3 class="font-semibold text-lg" style="color: ${textColor};">${act.activity_name}</h3>
                            <p class="text-sm text-gray-500">üìÖ ${formatDate(act.activity_date)}</p>
                            <p class="text-sm text-gray-500">üìç ${act.activity_location}</p>
                          </div>
                          <span class="status-badge status-aktif">Aktif</span>
                        </div>
                        ${alreadyAttended ? `
                          <div class="flex items-center gap-2 text-green-600 bg-green-50 px-4 py-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span class="font-medium">Sudah absen pada ${formatDateTime(alreadyAttended.attendance_time)}</span>
                          </div>
                        ` : `
                          <button onclick="startAttendance('${act.activity_name}')" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Absen Sekarang
                          </button>
                        `}
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>

            <!-- Attendance History -->
            <div class="rounded-2xl shadow-lg p-6" style="background: ${surfaceColor};">
              <h2 class="text-xl font-bold mb-6" style="color: ${textColor};">ÔøΩÔøΩ Riwayat Absensi</h2>
              
              ${userAttendances.length === 0 ? `
                <div class="text-center py-12 text-gray-400">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                  <p>Belum ada riwayat absensi</p>
                </div>
              ` : `
                <div class="space-y-3">
                  ${userAttendances.map(att => `
                    <div class="flex items-center gap-4 border rounded-xl p-4">
                      <img src="${att.attendance_photo || currentUser.photo}" class="w-12 h-12 rounded-lg object-cover" alt="Foto absensi">
                      <div class="flex-1">
                        <p class="font-semibold" style="color: ${textColor};">${att.activity_name}</p>
                        <p class="text-sm text-gray-500">${formatDateTime(att.attendance_time)}</p>
                      </div>
                      <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
      
      // Render data table after DOM is ready
      setTimeout(renderDataTable, 100);
    }

    let selectedActivity = null;

    function startAttendance(activityName) {
      selectedActivity = activityName;
      navigate('attendance');
    }

    function renderAttendance() {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;

      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${primaryColor} 0%, #0d1b2a 100%);">
          <div class="card-glass rounded-2xl p-8 w-full max-w-md shadow-xl" style="background: ${surfaceColor};">
            <button onclick="navigate('user-dashboard')" class="mb-6 flex items-center text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Kembali
            </button>
            
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold" style="color: ${textColor};">Absensi Kegiatan</h2>
              <p class="text-gray-500">${selectedActivity}</p>
            </div>

            <div class="mb-6">
              <div id="attendance-camera-container" class="camera-container bg-gray-900 rounded-xl overflow-hidden" style="height: 300px;">
                <video id="attendance-video" autoplay playsinline class="w-full h-full object-cover"></video>
                <div class="camera-overlay" id="attendance-camera-overlay">
                  <div class="face-guide"></div>
                </div>
              </div>
              <canvas id="attendance-canvas" class="hidden"></canvas>
              <div id="attendance-preview" class="hidden mt-4">
                <img id="attendance-preview-img" class="w-full rounded-xl" alt="Preview foto absensi">
              </div>
            </div>

            <div class="space-y-3">
              <button type="button" onclick="captureAttendancePhoto()" id="capture-btn" class="w-full text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2" style="background: ${secondaryColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Ambil Foto
              </button>
              <button type="button" onclick="submitAttendance()" id="submit-attendance-btn" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl hidden">
                ‚úì Konfirmasi Absensi
              </button>
            </div>
          </div>
        </div>
      `;
    }

    async function startCamera() {
      try {
        const video = document.getElementById('attendance-video');
        if (video) {
          videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user', width: 640, height: 480 } 
          });
          video.srcObject = videoStream;
          showToast('Kamera aktif! Posisikan wajah di dalam bingkai.');
        }
      } catch (err) {
        showToast('Gagal mengakses kamera. Pastikan izin kamera diberikan.', 'error');
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    }

    let capturedAttendancePhoto = null;

    function captureAttendancePhoto() {
      const video = document.getElementById('attendance-video');
      const canvas = document.getElementById('attendance-canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 320;
      canvas.height = 240;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      capturedAttendancePhoto = canvas.toDataURL('image/jpeg', 0.7);
      
      const preview = document.getElementById('attendance-preview');
      document.getElementById('attendance-preview-img').src = capturedAttendancePhoto;
      preview.classList.remove('hidden');
      
      document.getElementById('attendance-camera-overlay').style.display = 'none';
      document.getElementById('submit-attendance-btn').classList.remove('hidden');
      
      showToast('Foto berhasil diambil! Klik konfirmasi untuk absen.');
    }

    async function submitAttendance() {
      if (!capturedAttendancePhoto) {
        showToast('Silakan ambil foto terlebih dahulu', 'error');
        return;
      }

      const btn = document.getElementById('submit-attendance-btn');
      btn.disabled = true;
      btn.textContent = 'Memproses...';

      if (attendances.length >= 999) {
        showToast('Batas maksimum data tercapai', 'error');
        btn.disabled = false;
        btn.textContent = '‚úì Konfirmasi Absensi';
        return;
      }

      const result = await window.dataSdk.create({
        type: 'attendance',
        user_username: currentUser.username,
        activity_name: selectedActivity,
        attendance_photo: capturedAttendancePhoto,
        attendance_time: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('Absensi berhasil dicatat!');
        stopCamera();
        capturedAttendancePhoto = null;
        selectedActivity = null;
        navigate('user-dashboard');
      } else {
        showToast('Gagal mencatat absensi', 'error');
        btn.disabled = false;
        btn.textContent = '‚úì Konfirmasi Absensi';
      }
    }

    // Utility Functions
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Initialize
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c17d21946e8960c',t:'MTc2OTAwOTA5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

